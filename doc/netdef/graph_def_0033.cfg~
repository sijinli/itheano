# Modified from 0026
# Here is tried normalization layer after every fully connected prediction
# for regression 
#----------------------------------------------
# This is modified from graph 0019
# Here I replace logistic with softmax
# 
#----------------------------------------------------------
# 
# This is the first the network for face age classification
# 
# Basegraph: 0012
[imgdata]
type=data
inputs=s_imgdata
input_dims=(3, 175,175)
#channel, height, width

[labels]
type=data
inputs=s_labels
input_dims=1

[indlabel]
type=data
input_dims=40
inputs=s_indlabel

[conv1]
type=conv
inputs=imgdata
sizeX=16
sizeY=16
filters=16
strideX=1
strideY=1
board_mode=valid
initW=0.005
initb=0
wd=0
neuron=relu2
epsW=0.0005
epsB=0.002
# 16 @ 160 x 160

[pool1]
type=pool
inputs=conv1
sizeX=2
sizeY=2
strideX=2
strideY=2
pooling_type=max
# 16 @ 80 x 80

[conv1_fuse]
type=conv
inputs=pool1
sizeX=1
sizeY=1
filters=4
strideX=1
strideY=1
board_mode=valid
initW=0.1
initb=0
wd=0
neuron=relu2
epsW=0.0005
epsB=0.002
# 8 @ 80 x 80

[conv2]
type=conv
inputs=conv1_fuse
sizeX=9
sizeY=9
filters=32
strideX=1
strideY=1
board_mode=valid
initW=0.01
initb=0
wd=0
neuron=relu2
epsW=0.0005
epsB=0.002
# 32 @ 72 x 72

[pool2]
type=pool
inputs=conv2
sizeX=2
sizeY=2
strideX=2
strideY=2
pooling_type=max
# 32 @ 36 x 36


[conv2_fuse]
type=conv
inputs=pool2
sizeX=1
sizeY=1
filters=8
strideX=1
strideY=1
board_mode=valid
initW=0.1
initb=0
wd=0
neuron=relu2
epsW=0.0005
epsB=0.002
# 8 @ 36 x 36


[conv3]
type=conv
inputs=conv2_fuse
sizeX=5
sizeY=5
filters=64
strideX=1
strideY=1
board_mode=valid
initW=0.01
initb=0
wd=0
epsW=0.0005
epsB=0.002
#neuron=relu
# 64 @ 32 x 32

[pool3]
type=pool
inputs=conv3
sizeX=2
sizeY=2
strideX=2
strideY=2
pooling_type=max
# 64 @ 18 x 18

[conv3_fuse]
type=conv
inputs=pool3
sizeX=1
sizeY=1
filters=8
strideX=1
strideY=1
board_mode=valid
initW=0.01
initb=0
wd=0
neuron=relu2
epsW=0.0005
epsB=0.002
# 8 @ 18 x 18


[fc_ij0]
type=fc
inputs=conv3_fuse
output_dims=128
wd=0.01
initW=0.01
epsW=0.0005
epsB=0.002
initb=0
neuron=relu2

# [fc_ij0_dropout]
# type=dropout
# inputs=fc_ij0
# keep=0.5
[fc_ij0_norm]
type=batchnorm
inputs=fc_ij0

[fc_ij0_scale]
type=elemscale
inputs=fc_ij0_norm
wd=0.01
initW=0.01
initb=0
initWfunc=initfunc.constant(1)
initbfunc=initfunc.constant(0)
epsW=0.0005
epsB=0.002

[fc_ij1]
type=fc
inputs=fc_ij0_scale
output_dims=128
wd=0.01
initW=0.01
epsW=0.0005
epsB=0.002
initb=0
neuron=relu2

[fc_ij1_norm]
type=batchnorm
inputs=fc_ij1

[fc_ij1_scale]
type=elemscale
inputs=fc_ij1_norm
wd=0.01
initW=0.01
initb=0
initWfunc=initfunc.constant(1)
initbfunc=initfunc.constant(0)
epsW=0.0005
epsB=0.002


# [fc_ij1_dropout]
# type=dropout
# inputs=fc_ij1
# keep=0.25

[fc_ij2]
type=fc
inputs=fc_ij1_scale
output_dims=40
wd=0.01
initW=0.01
epsW=0.0005
epsB=0.002
initb=0
neuron=softmax

[fc_j0]
type=fc
inputs=conv3_fuse
output_dims=128
wd=0.01
initW=0.01
epsW=0.0005
epsB=0.002 
initb=0
neuron=relu2

[fc_j0_norm]
type=batchnorm
inputs=fc_j0

[fc_j0_scale]
type=elemscale
inputs=fc_j0_norm
wd=0.01
initW=0.1
initb=0
initWfunc=initfunc.constant(1)
initbfunc=initfunc.constant(0)
epsW=0.0005
epsB=0.002

# [fc_j0_dropout]
# type=dropout
# inputs=fc_j0
# keep=0.25

[fc_j1]
type=fc
inputs=fc_j0_scale
output_dims=128
wd=0.01
initW=0.01
epsW=0.0005
epsB=0.002
initb=0
neuron=relu2

[fc_j1_norm]
type=batchnorm
inputs=fc_j1

[fc_j1_scale]
type=elemscale
inputs=fc_j1_norm
wd=0.01
initW=0.01
initb=0
initWfunc=initfunc.constant(1)
initbfunc=initfunc.constant(0)
epsW=0.0005
epsB=0.002

# [fc_j1_dropout]
# type=dropout
# inputs=fc_j1
# keep=0.25

[fc_j2]
type=fc
inputs=fc_j1_scale
output_dims=1
wd=0.01
initW=0.01
epsW=0.0005
epsB=0.002
initb=0
neuron=relu2



[sqdiffcost]
type=cost.sqdiff
inputs=labels, fc_j2
coeff=0.5

[indcost]
type=cost.bce
inputs=indlabel,fc_ij2
coeff=5



[network]
type=network
cost_layer_names=indcost,sqdiffcost
data_layer_names=imgdata,labels, indlabel
output_layer_names=
# layer_with_weights=conv1,fc_ij0,fc_ij1,fc_ij2,fc_j0,fc_j1,fc_j2,conv1_fuse
# layer_with_weights=conv1,fc_ij2,fc_j2,conv1_fuse
layer_with_weights=conv1,conv2,conv3, conv1_fuse,conv2_fuse,conv3_fuse,fc_ij0,fc_ij1,fc_ij2,fc_j0,fc_j1,fc_j2,fc_j0_scale,fc_j1_scale,fc_ij0_scale,fc_ij1_scale